---
title: Socket 协议
icon: code
order: 2
category:
  - 开发指南
  - 通信协议
---

使用 Socket 协议作为默认通信协议。

## 通信路径定义

客户端连接时提供`项目路径`+`应用协议`

- Linux:`\0项目路径/应用协议`

```
␀/home/user/project/philia
```

- Windows:`\\?\pipe\项目路径\应用协议`

```
\\?\pipe\D:\project\philia
```

::: important
Windows 已经支持 UDS，但 Node.js 尚未支持，我们计划在 Node.js 支持后迁移到 UDS 以确保平台统一性，以及 UDS 性能比命名管道更高。
:::

- 其他如 macOS 保持原样

```
/home/user/project/philia
```

- 连接到远程主机，通过`tcp://host:port`打开 TCP 连接

## 编码长度

由于 Socket 粘包问题，协议规定了编码长度，拼接在编码数据前。

实际发送数据：长度`n(UInt32BE)`+数据`n字节`

因此一个数据包的最大长度为`4GB(2³²-1)`，如果发送的数据包长度超过 4GB，会分片处理，规则：

1. 单块：长度`4294967295(2³²-1)`+数据`4GB(2³²-1)`，最后一块：长度`n(UInt32BE)`+`数据 n字节`
2. 接收端收到时检测到长度`4GB(2³²-1)`，则认为数据包已分片，并继续读取数据
3. 直到读取到长度非`4GB(2³²-1)`，则数据包已接收完成，将所有接收数据拼接并解码

::: important
如果数据正好为`4GB(2³²-1)`的整数倍，则最后一块为 长度`0(UInt32BE)`无数据，请确保能正确处理。
:::
